version: '2'
services:
  jenkins:
    restart: always
    image: ${DOCKER_REGISTRY}/jenkins:${VERSION}
    user: jenkins
    env_file:
      - ${dockerconfig_root}/jenkins/jenkins.config.env
    environment:
      JENKINS_HOME: ${JENKINS_HOME}
      HOME: ${JENKINS_HOME}
    expose:
      - "8080"
    extra_hosts:
      - "host.docker:172.17.0.1"
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    dns:
      - 172.17.0.1
      - 8.8.8.8
    labels:
      #io.rancher.scheduler.affinity:host_label: 'jenkins=true'
      #traefik.domain: ${site_url}
      #traefik.port: '8080'
      #traefik.enable: 'true'
      ## Used to define what services are sidekicks (deployed into the same host needed to be able to use volumes_from)
      #io.rancher.sidekicks: jenkins-data
      SERVICE_8080_NAME: jenkins
      SERVICE_50000_IGNORE: 'true'
    volumes:
      - ${dockerconfig_root}/docker/ssl:/etc/docker
      - ${dockerconfig_root}/ssh:${JENKINS_HOME}/.ssh
      # If you use the docker in the host these variables shall not be tinkered with
      - ${JENKINS_HOME}:${JENKINS_HOME}
  jenkins-data:
    image: busybox
    entrypoint: ["chown", "-R", "1000:1000", "${JENKINS_HOME}", "${JENKINS_HOME}/.ssh"]
    network_mode: "none"
    volumes:
      - ${JENKINS_HOME}:${JENKINS_HOME}
      - ${dockerconfig_root}/ssh:${JENKINS_HOME}/.ssh
    #labels:
    #  io.rancher.container.start_once: 'true'
